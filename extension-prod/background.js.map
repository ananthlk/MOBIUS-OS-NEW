{"version":3,"file":"background.js","mappings":"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","sources":["webpack://mobius-os-extension/./src/background.ts"],"sourcesContent":["\"use strict\";\n/**\n * Background service worker for Mobius OS extension\n */\nchrome.runtime.onInstalled.addListener(() => {\n    console.log('[Mobius OS] Extension installed');\n    // Seed allowed domains for testing (only if unset).\n    // This keeps production behavior \"allowlist-driven\" while making initial dev testing easier.\n    const ALLOWED_DOMAINS_KEY = 'mobius.allowedDomains';\n    chrome.storage.local.get([ALLOWED_DOMAINS_KEY], (result) => {\n        const existing = result[ALLOWED_DOMAINS_KEY];\n        const current = Array.isArray(existing) ? existing : [];\n        // Keep this list conservative; user can toggle sites in the popup.\n        // Ensure entries exist even if the allowlist was already created.\n        const defaults = [\n            'localhost',\n            '127.0.0.1',\n            'example.com',\n            'google.com',\n            'www.google.com',\n        ];\n        const next = new Set(current.map((d) => String(d).toLowerCase()).filter(Boolean));\n        for (const d of defaults)\n            next.add(d);\n        chrome.storage.local.set({ [ALLOWED_DOMAINS_KEY]: Array.from(next).sort() }, () => {\n            console.log('[Mobius OS] Ensured allowlist entries for testing:', defaults);\n        });\n    });\n});\n// Keys that should persist across browser sessions (stored in local storage)\nconst PERSISTENT_KEYS = [\n    'mobius.auth.refreshToken',\n    'mobius.auth.userProfile',\n];\n/**\n * Auth Storage Message Handler\n * Content scripts cannot access chrome.storage.session directly,\n * so we proxy storage operations through the background script.\n *\n * Storage strategy:\n * - Refresh token + user profile → chrome.storage.local (persists across sessions)\n * - Access token + expiresAt → chrome.storage.session (cleared on browser close)\n */\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\n    if (!message || !message.type)\n        return false;\n    // Handle auth storage operations\n    if (message.type === 'mobius:auth:getStorage') {\n        const keys = message.keys;\n        // Split keys by storage type\n        const sessionKeys = keys.filter(k => !PERSISTENT_KEYS.includes(k));\n        const localKeys = keys.filter(k => PERSISTENT_KEYS.includes(k));\n        // Fetch from both storages and merge\n        Promise.all([\n            sessionKeys.length > 0 ? chrome.storage.session.get(sessionKeys) : Promise.resolve({}),\n            localKeys.length > 0 ? chrome.storage.local.get(localKeys) : Promise.resolve({}),\n        ]).then(([sessionData, localData]) => {\n            sendResponse({ ok: true, data: { ...sessionData, ...localData } });\n        }).catch((error) => {\n            console.error('[Mobius Background] Storage get error:', error);\n            sendResponse({ ok: false, error: String(error) });\n        });\n        return true; // Keep channel open for async response\n    }\n    if (message.type === 'mobius:auth:setStorage') {\n        const items = message.items;\n        // Split items by storage type\n        const sessionItems = {};\n        const localItems = {};\n        for (const [key, value] of Object.entries(items)) {\n            if (PERSISTENT_KEYS.includes(key)) {\n                localItems[key] = value;\n            }\n            else {\n                sessionItems[key] = value;\n            }\n        }\n        // Store in appropriate storage\n        Promise.all([\n            Object.keys(sessionItems).length > 0 ? chrome.storage.session.set(sessionItems) : Promise.resolve(),\n            Object.keys(localItems).length > 0 ? chrome.storage.local.set(localItems) : Promise.resolve(),\n        ]).then(() => {\n            sendResponse({ ok: true });\n        }).catch((error) => {\n            console.error('[Mobius Background] Storage set error:', error);\n            sendResponse({ ok: false, error: String(error) });\n        });\n        return true;\n    }\n    if (message.type === 'mobius:auth:clearStorage') {\n        const keys = message.keys;\n        if (keys) {\n            // Clear specific keys from appropriate storage\n            const sessionKeys = keys.filter(k => !PERSISTENT_KEYS.includes(k));\n            const localKeys = keys.filter(k => PERSISTENT_KEYS.includes(k));\n            Promise.all([\n                sessionKeys.length > 0 ? chrome.storage.session.remove(sessionKeys) : Promise.resolve(),\n                localKeys.length > 0 ? chrome.storage.local.remove(localKeys) : Promise.resolve(),\n            ]).then(() => {\n                sendResponse({ ok: true });\n            }).catch((error) => {\n                console.error('[Mobius Background] Storage clear error:', error);\n                sendResponse({ ok: false, error: String(error) });\n            });\n        }\n        else {\n            // Clear all auth data from both storages\n            Promise.all([\n                chrome.storage.session.clear(),\n                chrome.storage.local.remove(PERSISTENT_KEYS),\n            ]).then(() => {\n                sendResponse({ ok: true });\n            }).catch((error) => {\n                console.error('[Mobius Background] Storage clear error:', error);\n                sendResponse({ ok: false, error: String(error) });\n            });\n        }\n        return true;\n    }\n    return false;\n});\n"],"names":["chrome","runtime","onInstalled","addListener","console","log","ALLOWED_DOMAINS_KEY","storage","local","get","result","existing","current","Array","isArray","defaults","next","Set","map","d","String","toLowerCase","filter","Boolean","add","set","from","sort","PERSISTENT_KEYS","onMessage","message","_sender","sendResponse","type","keys","sessionKeys","k","includes","localKeys","Promise","all","length","session","resolve","then","sessionData","localData","ok","data","catch","error","items","sessionItems","localItems","key","value","Object","entries","remove","clear"],"ignoreList":[],"sourceRoot":""}